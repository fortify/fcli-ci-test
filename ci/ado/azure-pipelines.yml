# Pipeline parameters passed from external trigger
parameters:
  - name: PIPELINE_NAME
    type: string
    default: 'ci-test'
  - name: VERSION
    type: string
    default: ''
  - name: FCLI_VERSION
    type: string
    default: ''
  - name: PRODUCT
    type: string
    default: ''
  - name: COMPONENT
    type: string
    default: ''
  - name: SOURCE_DIR
    type: string
    default: ''
  - name: OS
    type: string
    default: 'linux'
  - name: FORTIFY_RELEASE
    type: string
    default: 'main'

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger: none

variables:
  - name: VM_IMAGE
    ${{ if eq(parameters.OS, 'linux') }}:
      value: 'ubuntu-latest'
    ${{ if eq(parameters.OS, 'windows') }}:
      value: 'windows-latest'
    ${{ if eq(parameters.OS, 'mac') }}:
      value: 'macOS-latest'

pool:
  vmImage: $(VM_IMAGE)

jobs:
  # No-op job when parameters aren't set (prevents empty pipeline)
  - job: no_op
    displayName: 'No-op (missing parameters)'
    condition: |
      or(
        eq('${{ parameters.VERSION }}', ''),
        eq('${{ parameters.COMPONENT }}', ''),
        and(
          eq('${{ parameters.COMPONENT }}', 'ast-scan'),
          and(
            ne('${{ parameters.PRODUCT }}', 'fod'),
            ne('${{ parameters.PRODUCT }}', 'ssc')
          )
        )
      )
    steps:
      - script: |
          echo "ERROR: Pipeline requires valid trigger parameters"
          echo "VERSION: ${{ parameters.VERSION }}"
          echo "COMPONENT: ${{ parameters.COMPONENT }}"
          echo "PRODUCT: ${{ parameters.PRODUCT }}"
          echo ""
          echo "This job fails to indicate that no actual test was run."
          exit 1
        displayName: 'Fail with error message'

  # Setup test (product-agnostic)
  - job: test_setup
    displayName: ${{ parameters.PIPELINE_NAME }}
    condition: and(succeeded(), ne('${{ parameters.VERSION }}', ''), eq('${{ parameters.COMPONENT }}', 'setup'))
    steps:
      - checkout: self
      
      - script: |
          echo "=== Pipeline Parameters ==="
          echo "VERSION: ${{ parameters.VERSION }}"
          echo "FCLI_VERSION: ${{ parameters.FCLI_VERSION }}"
          echo "COMPONENT: ${{ parameters.COMPONENT }}"
          echo "OS: ${{ parameters.OS }}"
          echo "=========================="
        displayName: 'Debug parameters'
      
      - ${{ if eq(parameters.OS, 'windows') }}:
        - pwsh: |
            Write-Host "Testing @fortify/setup ${{ parameters.VERSION }} bootstrap with shell approach"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
            npx @fortify/setup@v2 env pwsh | Out-String | Invoke-Expression
            fcli --version
          displayName: 'Test 1: Shell approach'
          env:
            FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
        
        - pwsh: |
            Write-Host "Testing @fortify/setup ${{ parameters.VERSION }} bootstrap with ADO approach"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
            npx @fortify/setup@v2 env ado
          displayName: 'Test 2: ADO approach - Initialize'
          env:
            FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
        
        - pwsh: |
            fcli --version
          displayName: 'Test 2: ADO approach - Verify'
      
      - ${{ if ne(parameters.OS, 'windows') }}:
        - bash: |
            echo "Testing @fortify/setup ${{ parameters.VERSION }} bootstrap with shell approach"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
            source <(npx @fortify/setup@v2 env shell)
            fcli --version
          displayName: 'Test 1: Shell approach'
          env:
            FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
        
        - bash: |
            echo "Testing @fortify/setup ${{ parameters.VERSION }} bootstrap with ADO approach"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
          displayName: 'Test 2: ADO approach - Initialize'
          env:
            FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
        
        - bash: |
            npx @fortify/setup@v2 env ado
          displayName: 'Test 2: ADO approach - Set env'
        
        - bash: |
            fcli --version
          displayName: 'Test 2: ADO approach - Verify'

  # FoD ast-scan test
  - job: test_fod_ast_scan
    displayName: ${{ parameters.PIPELINE_NAME }}
    condition: and(succeeded(), ne('${{ parameters.VERSION }}', ''), eq('${{ parameters.PRODUCT }}', 'fod'), eq('${{ parameters.COMPONENT }}', 'ast-scan'))
    steps:
      - checkout: self
      
      - script: |
          echo "=== Pipeline Parameters ==="
          echo "VERSION: ${{ parameters.VERSION }}"
          echo "FCLI_VERSION: ${{ parameters.FCLI_VERSION }}"
          echo "PRODUCT: ${{ parameters.PRODUCT }}"
          echo "COMPONENT: ${{ parameters.COMPONENT }}"
          echo "SOURCE_DIR: ${{ parameters.SOURCE_DIR }}"
          echo "OS: ${{ parameters.OS }}"
          echo "FORTIFY_RELEASE: ${{ parameters.FORTIFY_RELEASE }}"
          echo "=========================="
        displayName: 'Debug parameters'
      
      - task: Bash@3
        displayName: 'Test FoD ast-scan'
        inputs:
          targetType: 'inline'
          script: |
            echo "Testing @fortify/setup ${{ parameters.VERSION }} with fcli action run ci for FoD"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
            source <(npx @fortify/setup@v2 env shell)
            fcli action run ci
        env:
          FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
          FOD_URL: $(FCLI_FT_FOD_URL)
          FOD_CLIENT_ID: $(FCLI_FT_FOD_CLIENT_ID)
          FOD_CLIENT_SECRET: $(FCLI_FT_FOD_CLIENT_SECRET)
          FOD_RELEASE: ${{ parameters.FORTIFY_RELEASE }}
          SOURCE_DIR: $(Build.SourcesDirectory)/${{ parameters.SOURCE_DIR }}

  # SSC ast-scan test
  - job: test_ssc_ast_scan
    displayName: ${{ parameters.PIPELINE_NAME }}
    condition: and(succeeded(), ne('${{ parameters.VERSION }}', ''), eq('${{ parameters.PRODUCT }}', 'ssc'), eq('${{ parameters.COMPONENT }}', 'ast-scan'))
    steps:
      - checkout: self
      
      - script: |
          echo "=== Pipeline Parameters ==="
          echo "VERSION: ${{ parameters.VERSION }}"
          echo "FCLI_VERSION: ${{ parameters.FCLI_VERSION }}"
          echo "PRODUCT: ${{ parameters.PRODUCT }}"
          echo "COMPONENT: ${{ parameters.COMPONENT }}"
          echo "SOURCE_DIR: ${{ parameters.SOURCE_DIR }}"
          echo "OS: ${{ parameters.OS }}"
          echo "FORTIFY_RELEASE: ${{ parameters.FORTIFY_RELEASE }}"
          echo "=========================="
        displayName: 'Debug parameters'
      
      - task: Bash@3
        displayName: 'Test SSC ast-scan'
        inputs:
          targetType: 'inline'
          script: |
            echo "Testing @fortify/setup ${{ parameters.VERSION }} with fcli action run ci for SSC"
            npx @fortify/setup@v2 env init --tools=fcli:bootstrapped
            source <(npx @fortify/setup@v2 env shell)
            fcli action run ci
        env:
          FCLI_BOOTSTRAP_VERSION: ${{ parameters.FCLI_VERSION }}
          SSC_URL: $(FCLI_FT_SSC_URL)
          SSC_TOKEN: $(FCLI_FT_SSC_TOKEN)
          SC_SAST_TOKEN: $(FCLI_FT_SC_SAST_TOKEN)
          SSC_APPVERSION: ${{ parameters.FORTIFY_RELEASE }}
          SOURCE_DIR: $(Build.SourcesDirectory)/${{ parameters.SOURCE_DIR }}
          SETUP_EXTRA_OPTS: --issue-template "Prioritized High Risk Issue Template"
          SAST_SCAN_EXTRA_OPTS: --no-replace
